<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ESG Dashboard</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    .splash-screen {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: linear-gradient(135deg, rgb(102, 126, 234) 0%, rgb(118, 75, 162) 100%);
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      z-index: 9999; animation: fadeOut 1s ease-out 3s forwards;
    }
    @keyframes fadeOut { to { opacity: 0; visibility: hidden; } }

    .splash-logo { font-size: 80px; margin-bottom: 30px; animation: bounce 2s ease-in-out infinite; }
    @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }

    .splash-company {
      font-size: 48px; font-weight: bold; color: white; margin-bottom: 20px;
      animation: slideInFromLeft 1s ease-out; text-align: center; text-shadow: 0 5px 20px rgba(0,0,0,0.3);
    }
    @keyframes slideInFromLeft { from { opacity: 0; transform: translateX(-100px); } to { opacity: 1; transform: translateX(0); } }

    .splash-subtitle {
      font-size: 24px; color: rgba(255,255,255,0.9); margin-bottom: 40px;
      animation: slideInFromRight 1s ease-out 0.3s both;
    }
    @keyframes slideInFromRight { from { opacity: 0; transform: translateX(100px); } to { opacity: 1; transform: translateX(0); } }

    .splash-loader {
      width: 60px; height: 60px; border: 6px solid rgba(255,255,255,0.3);
      border-top: 6px solid white; border-radius: 50%; animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    .splash-text { color: white; margin-top: 20px; font-size: 18px; animation: pulse 1.5s ease-in-out infinite; }
    @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, rgb(102, 126, 234) 0%, rgb(118, 75, 162) 100%);
      min-height: 100vh; padding: 20px; overflow-x: hidden;
    }
    .container {
      max-width: 1600px; margin: 0 auto;
      animation: fadeIn 0.8s ease-out; opacity: 0; animation-delay: 3.5s; animation-fill-mode: forwards;
    }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    .header {
      background: white; border-radius: 20px; padding: 30px; margin-bottom: 30px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2); position: relative; overflow: hidden;
    }
    .header::before {
      content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 5px;
      background: linear-gradient(90deg, rgb(102, 126, 234), rgb(118, 75, 162), rgb(240, 147, 251));
      animation: shimmer 3s infinite;
    }
    @keyframes shimmer { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }

    .header h1 { color: rgb(102, 126, 234); font-size: 36px; margin-bottom: 10px; font-weight: 700; }
    .header .subtitle { color: #666; font-size: 16px; display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }

    .badge {
      display: inline-block; padding: 5px 15px; border-radius: 20px; font-size: 12px; font-weight: 600;
      background: linear-gradient(135deg, rgb(102, 126, 234), rgb(118, 75, 162)); color: white;
    }

    .trial-box {
      background: white; border-radius: 20px; padding: 25px; margin-bottom: 30px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }
    .trial-title { font-size: 22px; font-weight: 800; margin-bottom: 10px; color: #222; }
    .trial-line { color: #333; font-size: 16px; margin: 4px 0; }

    .search-box {
      background: white; border-radius: 20px; padding: 25px; margin-bottom: 30px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }
    .search-input {
      width: 100%; padding: 18px 25px; font-size: 18px; border: 3px solid #e0e0e0;
      border-radius: 50px; outline: none; transition: all 0.3s; background: #fafafa;
    }
    .search-input:focus {
      border-color: rgb(102, 126, 234); box-shadow: 0 0 0 5px rgba(102, 126, 234, 0.1);
      background: white; transform: translateY(-2px);
    }

    .stats-summary {
      background: white; border-radius: 20px; padding: 30px; margin-bottom: 30px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2); display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 30px;
    }
    .stat-item {
      text-align: center; padding: 20px; border-radius: 15px; transition: all 0.3s; cursor: pointer;
    }
    .stat-item:hover { transform: translateY(-5px) scale(1.05); box-shadow: 0 15px 30px rgba(0,0,0,0.15); }
    .stat-item:nth-child(1) { background: linear-gradient(135deg, rgb(102, 126, 234) 0%, rgb(118, 75, 162) 100%); color: white; }
    .stat-item:nth-child(2) { background: linear-gradient(135deg, rgb(240, 147, 251) 0%, rgb(245, 87, 108) 100%); color: white; }
    .stat-item:nth-child(3) { background: linear-gradient(135deg, rgb(79, 172, 254) 0%, rgb(0, 242, 254) 100%); color: white; }
    .stat-item .stat-number { font-size: 48px; font-weight: bold; margin-bottom: 10px; }
    .stat-item .stat-label { font-size: 14px; opacity: 0.9; font-weight: 500; }

    .tabs { display: flex; gap: 15px; margin-bottom: 30px; flex-wrap: wrap; }
    .tab {
      padding: 15px 30px; background: white; border-radius: 15px; cursor: pointer;
      transition: all 0.3s; font-weight: 600; box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    .tab:hover { transform: translateY(-3px); box-shadow: 0 10px 25px rgba(0,0,0,0.15); }
    .tab.active {
      background: linear-gradient(135deg, rgb(102, 126, 234), rgb(118, 75, 162));
      color: white; transform: translateY(-3px);
    }

    .charts-section {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
      gap: 25px; margin-bottom: 30px;
    }
    .chart-card {
      background: white; border-radius: 20px; padding: 25px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.15); transition: all 0.3s;
    }
    .chart-card:hover { transform: translateY(-5px); box-shadow: 0 20px 50px rgba(0,0,0,0.2); }
    .chart-card h3 {
      color: #333; margin-bottom: 20px; font-size: 18px; font-weight: 600;
      display: flex; align-items: center; gap: 10px;
    }
    .chart-container { position: relative; height: 300px; }

    .results-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
    .result-card {
      background: white; border-radius: 20px; padding: 25px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.1); transition: all 0.4s;
      cursor: pointer; position: relative; overflow: hidden;
    }
    .result-card:hover { transform: translateY(-10px) scale(1.02); box-shadow: 0 20px 40px rgba(0,0,0,0.2); }

    .result-card .category {
      display: inline-block; padding: 6px 15px; border-radius: 20px;
      font-size: 11px; font-weight: bold; margin-bottom: 15px;
      text-transform: uppercase; letter-spacing: 0.5px;
    }
    .category.cpc { background: linear-gradient(135deg, rgb(102, 126, 234), rgb(118, 75, 162)); color: white; }
    .category.bilan { background: linear-gradient(135deg, rgb(240, 147, 251), rgb(245, 87, 108)); color: white; }

    .result-card .name { font-size: 15px; color: #333; margin-bottom: 20px; font-weight: 600; line-height: 1.4; }
    .result-card .value {
      font-size: 36px; font-weight: bold;
      background: linear-gradient(135deg, rgb(102, 126, 234), rgb(118, 75, 162));
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      background-clip: text; margin-bottom: 8px;
    }
    .result-card .unit { font-size: 13px; color: #999; font-weight: 500; }

    .no-results { text-align: center; padding: 80px 20px; color: white; font-size: 18px; }
    .no-results-icon { font-size: 80px; margin-bottom: 20px; opacity: 0.7; }

    .theme-toggle {
      position: fixed; top: 20px; right: 20px; background: white; border-radius: 50%;
      width: 60px; height: 60px; display: flex; align-items: center; justify-content: center;
      cursor: pointer; box-shadow: 0 5px 20px rgba(0,0,0,0.2); transition: all 0.3s; z-index: 1000;
    }
    .theme-toggle:hover { transform: scale(1.1) rotate(180deg); }

    @media (max-width: 768px) {
      .splash-company { font-size: 32px; }
      .splash-subtitle { font-size: 18px; }
      .results-container { grid-template-columns: 1fr; }
      .charts-section { grid-template-columns: 1fr; }
      .header h1 { font-size: 24px; }
    }
  </style>
</head>

<body>
  <div class="splash-screen" id="splashScreen">
    <div class="splash-logo">üìä</div>
    <div class="splash-company" id="splashCompany">CHARGEMENT...</div>
    <div class="splash-subtitle" id="splashSubtitle">ESG Reporting Dashboard</div>
    <div class="splash-loader"></div>
    <div class="splash-text" id="splashText">Chargement des donn√©es...</div>
  </div>

  <div class="theme-toggle" onclick="toggleTheme()" title="Changer le th√®me">
    <span style="font-size: 28px;">üåô</span>
  </div>

  <div class="container">
    <div class="trial-box" id="trialBox" style="display:none;">
      <div class="trial-title">üìä ESG Reporting Dashboard (TRIAL)</div>
      <div class="trial-line"><b>Client:</b> <span id="trialClient">-</span></div>
      <div class="trial-line"><b>Valid until:</b> <span id="trialValidUntil">-</span></div>
      <div class="trial-line"><b>Views used:</b> <span id="trialViewsUsed">-</span></div>
    </div>

    <div class="header">
      <h1>üìä ESG Reporting Dashboard</h1>
      <div class="subtitle">
        <span id="hdrClient">-</span>
        <span class="badge" id="hdrYear">Ann√©e -</span>
        <span id="hdrUpdated">Mis √† jour le -</span>
      </div>
    </div>

    <div class="stats-summary">
      <div class="stat-item">
        <div class="stat-number" id="totalIndicators">-</div>
        <div class="stat-label">üìà Indicateurs totaux</div>
      </div>
      <div class="stat-item">
        <div class="stat-number" id="cpcCount">-</div>
        <div class="stat-label">üí∞ Indicateurs CPC</div>
      </div>
      <div class="stat-item">
        <div class="stat-number" id="bilanCount">-</div>
        <div class="stat-label">üìä Indicateurs Bilan</div>
      </div>
    </div>

    <div class="tabs">
      <div class="tab active" onclick="showTab('all')">üìã Tous</div>
      <div class="tab" onclick="showTab('cpc')">üí∞ CPC</div>
      <div class="tab" onclick="showTab('bilan')">üìä Bilan</div>
      <div class="tab" onclick="showTab('charts')">üìà Graphiques</div>
    </div>

    <div class="charts-section" id="chartsSection" style="display: none;">
      <div class="chart-card"><h3>üìä Principaux indicateurs ESG</h3><div class="chart-container"><canvas id="esgChart"></canvas></div></div>
      <div class="chart-card"><h3>üìà Ratios de performance</h3><div class="chart-container"><canvas id="ratiosChart"></canvas></div></div>
      <div class="chart-card"><h3>üí∞ √âvolution des marges</h3><div class="chart-container"><canvas id="margesChart"></canvas></div></div>
      <div class="chart-card"><h3>üìâ Structure du bilan</h3><div class="chart-container"><canvas id="bilanChart"></canvas></div></div>
      <div class="chart-card"><h3>üéØ Indicateurs cl√©s (KPI)</h3><div class="chart-container"><canvas id="kpiChart"></canvas></div></div>
      <div class="chart-card"><h3>üìä Comparaison Actif/Passif</h3><div class="chart-container"><canvas id="actifPassifChart"></canvas></div></div>
    </div>

    <div class="search-box">
      <input type="text" id="searchInput" class="search-input"
             placeholder="üîç Rechercher un indicateur..." autocomplete="off">
    </div>

    <div id="resultsContainer" class="results-container"></div>

    <div id="noResults" class="no-results" style="display: none;">
      <div class="no-results-icon">üîç</div>
      <div>Aucun r√©sultat trouv√©</div>
    </div>
  </div>

  <script>
    // IMPORTANT: ici, au lieu de "const data = {...}" comme avant, on charge depuis ton backend.
    let data = {};
    let currentSearch = '', currentTab = 'all', charts = {};

    document.addEventListener('DOMContentLoaded', async function() {
      try {
        // Exemple:
        // - si tu ouvres /report/RELAISMEDICAL
        // - ton backend peut servir ce HTML et le client est dans l'URL
        const parts = window.location.pathname.split('/').filter(Boolean);
        const client = (parts[0] === 'report' && parts[1]) ? parts[1] : null;

        // Fallback: si pas /report/<client>, essaye query ?client=
        const urlParams = new URLSearchParams(window.location.search);
        const clientQ = urlParams.get('client');
        const clientName = client || clientQ || 'CLIENT';

        // Affiche dans le splash direct
        document.getElementById('splashCompany').textContent = clientName;
        document.getElementById('splashSubtitle').textContent = 'ESG Reporting Dashboard';

        // Appel API (√† impl√©menter c√¥t√© backend)
        const res = await fetch(`/api/report/${encodeURIComponent(clientName)}`, {
          headers: { 'Accept': 'application/json' }
        });

        if (!res.ok) {
          document.getElementById('splashText').textContent = `Erreur chargement: HTTP ${res.status}`;
          throw new Error(`API error: ${res.status}`);
        }

        const payload = await res.json();

        // Remplit les m√©tas
        const pClient = payload.client || clientName;
        const pYear = payload.year || '-';
        const pUpdated = payload.updated_at || '-';

        document.title = `ESG Dashboard - ${pClient} ${pYear}`;
        document.getElementById('hdrClient').textContent = pClient;
        document.getElementById('hdrYear').textContent = `Ann√©e ${pYear}`;
        document.getElementById('hdrUpdated').textContent = `Mis √† jour le ${pUpdated}`;

        // TRIAL (optionnel)
        if (payload.trial) {
          document.getElementById('trialBox').style.display = 'block';
          document.getElementById('trialClient').textContent = pClient;
          document.getElementById('trialValidUntil').textContent = payload.trial.valid_until || '-';
          const used = payload.trial.views_used ?? '-';
          const max = payload.trial.views_max ?? '-';
          document.getElementById('trialViewsUsed').textContent = `${used}/${max}`;
        }

        // Donn√©es
        data = payload.data || {};

        // Lance UI
        setTimeout(() => document.getElementById('splashScreen').style.display = 'none', 3000);
        updateStats();
        displayAllResults();
        initCharts();

        document.getElementById('searchInput').addEventListener('input', function(e) {
          currentSearch = e.target.value.toLowerCase().trim();
          currentSearch === '' ? displayResults(currentTab) : performSearch();
        });

      } catch (err) {
        console.error(err);
        // Splash reste visible avec message d'erreur
      }
    });

    function toggleTheme() {
      const body = document.body;
      body.style.background = body.style.background.includes('102')
        ? 'linear-gradient(135deg, rgb(44, 62, 80) 0%, rgb(52, 73, 94) 100%)'
        : 'linear-gradient(135deg, rgb(102, 126, 234) 0%, rgb(118, 75, 162) 100%)';
    }

    function showTab(tab) {
      currentTab = tab;
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');
      if (tab === 'charts') {
        document.getElementById('chartsSection').style.display = 'grid';
        document.getElementById('resultsContainer').style.display = 'none';
        document.querySelector('.search-box').style.display = 'none';
      } else {
        document.getElementById('chartsSection').style.display = 'none';
        document.getElementById('resultsContainer').style.display = 'grid';
        document.querySelector('.search-box').style.display = 'block';
        displayResults(tab);
      }
    }

    function initCharts() {
      // d√©truit si d√©j√† cr√©√©
      Object.values(charts).forEach(c => { try { c.destroy(); } catch(e){} });
      charts = {};

      const esgData = Object.entries(data).filter(([_, i]) => i.category === 'CPC' && i.type === 'Montant').slice(0, 8);
      const ratiosData = Object.entries(data).filter(([_, i]) => i.type === 'Ratio' && i.category === 'CPC').slice(0, 6);
      const bilanData = Object.entries(data).filter(([_, i]) => i.category === 'Bilan' && i.type === 'Montant').slice(0, 8);

      charts.esg = new Chart(document.getElementById('esgChart'), {
        type: 'bar',
        data: { labels: esgData.map(([n]) => n), datasets: [{ data: esgData.map(([_, i]) => i.value),
          backgroundColor: 'rgba(102, 126, 234, 0.8)', borderRadius: 10 }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } },
          animation: { duration: 2000, easing: 'easeOutBounce' } }
      });

      charts.ratios = new Chart(document.getElementById('ratiosChart'), {
        type: 'doughnut',
        data: { labels: ratiosData.map(([n]) => n), datasets: [{ data: ratiosData.map(([_, i]) => Math.abs(i.value)),
          backgroundColor: ['rgba(102,126,234,0.8)','rgba(240,147,251,0.8)','rgba(79,172,254,0.8)',
            'rgba(245,87,108,0.8)','rgba(250,177,160,0.8)','rgba(139,195,74,0.8)'], borderWidth: 3 }] },
        options: { responsive: true, maintainAspectRatio: false, animation: { duration: 2000 } }
      });

      const margeData = Object.entries(data).filter(([n]) => n.toLowerCase().includes('marge')).slice(0, 5);
      charts.marges = new Chart(document.getElementById('margesChart'), {
        type: 'line',
        data: { labels: margeData.map(([n]) => n), datasets: [{ data: margeData.map(([_, i]) => i.value),
          borderColor: 'rgba(240,147,251,1)', backgroundColor: 'rgba(240,147,251,0.2)', tension: 0.4, fill: true }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
      });

      charts.bilan = new Chart(document.getElementById('bilanChart'), {
        type: 'bar',
        data: { labels: bilanData.map(([n]) => n), datasets: [{ data: bilanData.map(([_, i]) => i.value),
          backgroundColor: ['rgba(79,172,254,0.8)','rgba(245,87,108,0.8)','rgba(139,195,74,0.8)',
            'rgba(255,193,7,0.8)','rgba(156,39,176,0.8)','rgba(233,30,99,0.8)'], borderRadius: 10 }] },
        options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false,
          plugins: { legend: { display: false } }, animation: { duration: 2000 } }
      });

      const kpiData = ratiosData.slice(0, 5);
      charts.kpi = new Chart(document.getElementById('kpiChart'), {
        type: 'radar',
        data: { labels: kpiData.map(([n]) => n), datasets: [{ data: kpiData.map(([_, i]) => Math.abs(i.value)),
          backgroundColor: 'rgba(102,126,234,0.2)', borderColor: 'rgba(102,126,234,1)', borderWidth: 3 }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
      });

      const actifData = Object.entries(data).filter(([n]) =>
        n.includes('Actif') || n.includes('Stock') || n.includes('Tr√©sorerie')).slice(0, 4);
      const passifData = Object.entries(data).filter(([n]) =>
        n.includes('Passif') || n.includes('Capitaux') || n.includes('Dette')).slice(0, 4);
      const combinedData = [...actifData, ...passifData];

      charts.actifPassif = new Chart(document.getElementById('actifPassifChart'), {
        type: 'polarArea',
        data: { labels: combinedData.map(([n]) => n), datasets: [{
          data: combinedData.map(([_, i]) => Math.abs(i.value)),
          backgroundColor: ['rgba(255,99,132,0.7)','rgba(54,162,235,0.7)','rgba(255,206,86,0.7)',
            'rgba(75,192,192,0.7)','rgba(153,102,255,0.7)','rgba(255,159,64,0.7)'] }] },
        options: { responsive: true, maintainAspectRatio: false, animation: { duration: 2000 } }
      });
    }

    function updateStats() {
      const total = Object.keys(data).length;
      const cpc = Object.values(data).filter(d => d.category === 'CPC').length;
      const bilan = Object.values(data).filter(d => d.category === 'Bilan').length;
      animateNumber('totalIndicators', total);
      animateNumber('cpcCount', cpc);
      animateNumber('bilanCount', bilan);
    }

    function animateNumber(elementId, targetValue) {
      const element = document.getElementById(elementId);
      let current = 0, increment = targetValue / 50;
      const timer = setInterval(() => {
        current += increment;
        if (current >= targetValue) { element.textContent = targetValue; clearInterval(timer); }
        else { element.textContent = Math.floor(current); }
      }, 20);
    }

    function displayResults(tab) {
      const container = document.getElementById('resultsContainer');
      container.innerHTML = '';
      document.getElementById('noResults').style.display = 'none';
      let filtered = Object.entries(data);
      if (tab === 'cpc') filtered = filtered.filter(([_, i]) => i.category === 'CPC');
      else if (tab === 'bilan') filtered = filtered.filter(([_, i]) => i.category === 'Bilan');
      filtered.forEach(([name, info]) => container.appendChild(createResultCard(name, info)));
    }

    function displayAllResults() { displayResults('all'); }

    function performSearch() {
      const container = document.getElementById('resultsContainer');
      const noResults = document.getElementById('noResults');
      container.innerHTML = '';
      const results = Object.entries(data).filter(([name]) => name.toLowerCase().includes(currentSearch));
      if (results.length === 0) noResults.style.display = 'block';
      else {
        noResults.style.display = 'none';
        results.forEach(([n, i]) => container.appendChild(createResultCard(n, i)));
      }
    }

    function createResultCard(name, info) {
      const card = document.createElement('div');
      card.className = 'result-card';
      card.innerHTML = `
        <div class="category ${info.category.toLowerCase()}">${info.category}</div>
        <div class="name">${name}</div>
        <div class="value">${formatNumber(info.value)}</div>
        <div class="unit">${info.unit}</div>
      `;
      return card;
    }

    function formatNumber(value) {
      return new Intl.NumberFormat('fr-FR', { minimumFractionDigits: 0, maximumFractionDigits: 2 }).format(value);
    }
  </script>
</body>
</html>
